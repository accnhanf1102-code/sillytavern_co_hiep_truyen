<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁÇº‰∏πÊ®°ÊãüÂô®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700&family=ZCOOL+XiaoWei&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --ink-black: #2b2b2b;
            --ink-light: #5a5a5a;
            --paper-bg: #f4f1e4;
            --paper-dark: #e6e2d3;
            --cinnabar: #8e1e20;
            --jade: #4d6e6e;
            --gold: #bfa36f;

            --base-spacing: 1%;
            --border-thick: 0.3rem;
            --border-thin: 0.15rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'ZCOOL XiaoWei', 'Noto Serif SC', serif;
            background-color: var(--paper-bg);
            background-image:
                radial-gradient(var(--paper-dark) 15%, transparent 16%),
                radial-gradient(var(--paper-dark) 15%, transparent 16%);
            background-size: 1rem 1rem;
            background-position: 0 0, 0.5rem 0.5rem;
            color: var(--ink-black);
        }

        .game-container {
            background: rgba(255, 255, 255, 0.65);
            border: var(--border-thick) double var(--ink-black);
            /* Â°´Êª°Êï¥‰∏™ËßÜÁ™ó */
            width: 100%;
            height: 100%;
            padding: 1%;
            position: relative;
            box-shadow: none;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .game-container::after {
            content: "‚ùñ";
            position: absolute;
            top: 0.2rem;
            right: 0.2rem;
            color: var(--ink-light);
            opacity: 0.6;
            font-size: 0.8rem;
        }

        .game-container::before {
            content: "‚ùñ";
            position: absolute;
            bottom: 0.2rem;
            left: 0.2rem;
            color: var(--ink-light);
            opacity: 0.6;
            font-size: 0.8rem;
        }

        /* ========== ÈÄÄÂá∫ÊåâÈíÆÊ†∑Âºè - ÂìçÂ∫îÂºè‰ºòÂåñ ========== */
        .exit-btn {
            position: absolute;
            top: 1%;
            right: 1%;
            padding: clamp(0.3rem, 0.8vw, 0.6rem) clamp(0.5rem, 1.2vw, 1rem);
            background: var(--cinnabar);
            color: #fff;
            border: clamp(1px, 0.2vw, 2px) solid var(--ink-black);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.6rem, 1.2vw, 1rem);
            cursor: pointer;
            z-index: 100;
            box-shadow: 0.1rem 0.1rem 0.3rem rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .exit-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0.4rem rgba(0, 0, 0, 0.4);
            background: var(--ink-black);
        }

        /* Â∞èËßÜÁ™ó‰∏ãÈÄÄÂá∫ÊåâÈíÆËøõ‰∏ÄÊ≠•Áº©Â∞è */
        @media (max-width: 500px),
        (max-height: 400px) {
            .exit-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.55rem;
                border-width: 1px;
                top: 0.5%;
                right: 0.5%;
            }
        }

        /* ÊûÅÂ∞èËßÜÁ™ó */
        @media (max-width: 350px),
        (max-height: 300px) {
            .exit-btn {
                padding: 0.15rem 0.3rem;
                font-size: 0.5rem;
            }
        }

        /* ========== ÈÄÄÂá∫Á°ÆËÆ§ÂºπÁ™ó ========== */
        .exit-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
        }

        .exit-dialog {
            width: clamp(260px, 80vw, 420px);
            max-width: 90vw;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            background: var(--paper-bg);
            color: var(--ink-black);
            border: var(--border-thick) double var(--ink-black);
        }

        .exit-dialog header {
            padding: 14px;
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1.2rem, 2.5vw, 1.5rem);
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid var(--ink-black);
            background: rgba(0, 0, 0, 0.05);
        }

        .exit-dialog .body {
            padding: 20px;
            text-align: center;
            line-height: 1.6;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }

        .exit-dialog .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.05);
        }

        .exit-dialog .actions button {
            padding: 10px 14px;
            border-radius: 8px;
            border: 2px solid var(--ink-black);
            background: #fff;
            color: var(--ink-black);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.2rem);
            cursor: pointer;
            transition: all 0.2s;
        }

        .exit-dialog .actions button:hover {
            background: var(--paper-dark);
        }

        .exit-dialog .actions button.confirm {
            background: var(--cinnabar);
            color: #fff;
            border-color: var(--cinnabar);
        }

        .exit-dialog .actions button.confirm:hover {
            background: var(--ink-black);
            border-color: var(--ink-black);
        }

        /* ========== ÂºÄÂßãÁÇº‰∏πÊåâÈíÆ - ÂìçÂ∫îÂºè‰ºòÂåñ ========== */
        .start-alchemy-btn {
            position: absolute;
            bottom: 15.5%;
            left: 50%;
            transform: translateX(-50%);
            width: 15%;
            aspect-ratio: 1/1;
            background: radial-gradient(circle, rgba(6, 116, 98, 0.95) 0%, rgba(6, 116, 98, 0.95) 70%);
            border: 2px solid var(--ink-black);
            border-radius: 50%;
            color: #fff;
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.7rem, 2vw, 2rem);
            /* Èôç‰ΩéÊúÄÂ∞èÂ≠ó‰ΩìÂ§ßÂ∞è */
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 20px rgba(142, 30, 32, 0.5), 0.2rem 0.2rem 0.5rem rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: btnPulse 2s infinite;
            white-space: nowrap;
            /* Èò≤Ê≠¢ÊñáÂ≠óÊç¢Ë°å */
            overflow: hidden;
            /* Á°Æ‰øù‰∏ç‰ºöÊ∫¢Âá∫ */
        }

        .start-alchemy-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 0 30px rgba(142, 30, 32, 0.7), 0.3rem 0.3rem 0.6rem rgba(0, 0, 0, 0.4);
        }

        .start-alchemy-btn.hidden {
            display: none;
        }

        @keyframes btnPulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(142, 30, 32, 0.5), 0.2rem 0.2rem 0.5rem rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 30px rgba(142, 30, 32, 0.8), 0.2rem 0.2rem 0.5rem rgba(0, 0, 0, 0.3);
            }
        }

        /* ========== Ê∂àÊÅØÊèêÁ§∫ ========== */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--paper-bg);
            border: 2px solid var(--ink-black);
            padding: clamp(1rem, 2vw, 1.5rem) clamp(1.5rem, 3vw, 2rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.2rem);
            z-index: 10001;
            box-shadow: 0.5rem 0.5rem 1rem rgba(0, 0, 0, 0.3);
            display: none;
            text-align: center;
            max-width: 80vw;
        }

        .toast.show {
            display: block;
            animation: toastFadeIn 0.3s;
        }

        .toast.success {
            border-color: var(--jade);
            color: var(--jade);
        }

        .toast.error {
            border-color: var(--cinnabar);
            color: var(--cinnabar);
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* ========== È°∂ÈÉ®‰∫ã‰ª∂Ê®™ÂπÖ ========== */
        .event-banner {
            height: 10%;
            min-height: 0;
            margin-bottom: 1%;
            display: flex;
            flex-direction: column;
            gap: 2%;
            overflow: hidden;
            width: 80%;
            /* ÂÆΩÂ∫¶80%ÔºåÂè≥‰æßÁ©∫Âá∫20%ÁªôÈÄÄÂá∫ÊåâÈíÆ */
        }

        .event-card {
            background: var(--paper-dark);
            border: 1px solid var(--ink-black);
            padding: 0.5% 1%;
            font-size: clamp(0.6rem, 1.2vw, 0.85rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.4s ease;
            border-left: 0.2rem solid var(--ink-black);
            min-height: 0;
        }

        .event-card.positive {
            border-left-color: var(--jade);
        }

        .event-card.negative {
            border-left-color: var(--cinnabar);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-0.5rem);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== Ê†∏ÂøÉÂå∫ÂüüÔºö‰∏πÁÇâ + Á∫µÂêëËøõÂ∫¶Êù° + ÁÅ´ÁÑ∞ ========== */
        .main-stage {
            position: relative;
            width: 100%;
            height: 55%;
            margin-bottom: 2%;
            display: flex;
            justify-content: center;
        }

        .furnace-container {
            position: relative;
            width: 60%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        /* Á∫µÂêëËøõÂ∫¶Êù°ÂÆπÂô® */
        .vertical-gauge {
            position: absolute;
            top: 3%;
            bottom: 0;
            width: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .vertical-gauge.left {
            left: 5%;
        }

        .vertical-gauge.right {
            right: 5%;
        }

        .gauge-label {
            font-size: clamp(0.6rem, 1.2vw, 1rem);
            font-family: 'Ma Shan Zheng';
            margin-bottom: 2%;
            writing-mode: vertical-rl;
            letter-spacing: 0.1rem;
        }

        .gauge-value {
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            font-family: 'Ma Shan Zheng';
            font-weight: bold;
            color: var(--ink-black);
            margin-bottom: 5%;
        }

        .gauge-track {
            width: 0.5rem;
            height: 75%;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid var(--ink-black);
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            transition: height 0.5s ease;
        }

        .fill-quality {
            background: var(--jade);
        }

        .fill-completion {
            background: var(--ink-black);
        }

        /* ÁÅ´ÁÑ∞ÂÆπÂô® */
        .furnace-fire-wrapper {
            position: absolute;
            bottom: 7%;
            left: 50%;
            transform: translateX(-50%);
            width: 25%;
            aspect-ratio: 1/1;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .furnace-fire-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 100, 0, 0.6) 0%, transparent 70%);
            filter: blur(8px);
            animation: pulse 2s infinite;
            transition: background 0.5s;
        }

        .temp-display {
            position: relative;
            z-index: 2;
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2.5vw, 2rem);
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        .furnace-fire-bg.normal {
            background: radial-gradient(circle, rgba(255, 160, 50, 0.6) 0%, transparent 70%);
        }

        .furnace-fire-bg.hot {
            background: radial-gradient(circle, rgba(255, 60, 0, 0.8) 0%, transparent 70%);
        }

        .furnace-fire-bg.cold {
            background: radial-gradient(circle, rgba(100, 200, 200, 0.5) 0%, transparent 70%);
        }

        .furnace-fire-bg.danger {
            background: radial-gradient(circle, rgba(220, 0, 0, 0.9) 0%, transparent 70%);
            animation: shake 0.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(-2px, 2px) scale(1.1);
            }

            75% {
                transform: translate(2px, -2px) scale(1.1);
            }
        }

        .furnace-image {
            position: relative;
            width: 90%;
            height: 100%;
            background: url('assets/image/static/ÁÇº‰∏πÁÇâ.png') no-repeat center bottom;
            background-size: contain;
            z-index: 2;
            pointer-events: none;
        }

        .furnace-image:empty::after {
            content: "‰∏πÁÇâ";
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            font-size: 2rem;
            font-family: 'Ma Shan Zheng';
        }

        /* ========== ‰ø°ÊÅØÊ†è ========== */
        .info-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 8%;
            margin-bottom: 2%;
            padding: 0.5% 0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .info-item {
            text-align: center;
            flex: 1;
        }

        .info-label {
            font-size: clamp(0.5rem, 1vw, 0.7rem);
            color: var(--ink-light);
        }

        .info-value {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.8rem, 1.6vw, 1.2rem);
            color: var(--ink-black);
        }

        .info-value.danger-text {
            color: var(--cinnabar);
        }

        /* ========== ÊéßÂà∂ÊåâÈíÆ ========== */
        .controls {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1%;
            height: 10%;
            margin-bottom: 2%;
        }

        .control-btn {
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            color: var(--ink-black);
            padding: 0;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0.1rem 0.1rem 0 rgba(0, 0, 0, 0.1);
            min-height: 0;
        }

        .control-btn:hover:not(:disabled) {
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0 rgba(0, 0, 0, 0.15);
            border-color: var(--cinnabar);
            color: var(--cinnabar);
        }

        .control-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 0;
        }

        .control-btn:disabled {
            opacity: 0.5;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            line-height: 1;
        }

        /* ========== Ê∂àÊÅØ ========== */
        .message {
            text-align: center;
            padding: 1%;
            margin: 0;
            height: 8%;
            font-size: clamp(0.6rem, 1.2vw, 0.8rem);
            border: 1px dashed var(--ink-black);
            display: none;
            background: rgba(255, 255, 255, 0.5);
        }

        .message.success {
            color: var(--jade);
            border-color: var(--jade);
        }

        .message.failure {
            color: var(--cinnabar);
            border-color: var(--cinnabar);
        }

        .tooltip {
            position: fixed;
            background: var(--paper-bg);
            border: 2px solid var(--ink-black);
            padding: 0.8rem;
            font-size: 0.8rem;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0.4rem 0.4rem 0.8rem rgba(0, 0, 0, 0.2);
            width: max-content;
            max-width: 80vw;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            font-family: 'Ma Shan Zheng';
            font-size: 1rem;
            color: var(--cinnabar);
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
            margin-bottom: 0.4rem;
        }

        .tooltip-range {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        .tooltip-value.positive {
            color: var(--jade);
        }

        .tooltip-value.negative {
            color: var(--cinnabar);
        }

        /* ========== ÈÄöÁî®ÂºπÁ™ó ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(43, 43, 43, 0.7);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* ÂºπÁ™óÂ±ÇÁ∫ßËÆæÁΩÆ */
        #event-modal-overlay {
            z-index: 9998;
        }

        #herb-modal-overlay {
            z-index: 9999;
        }

        #shop-modal-overlay {
            z-index: 10000;
        }

        #inventory-modal-overlay {
            z-index: 10001;
        }

        .modal {
            background: rgba(255, 255, 255, 0.65);
            border: var(--border-thick) double var(--ink-black);
            width: 90vw;
            max-width: 1216px;
            aspect-ratio: 1216 / 832;
            padding: 1%;
            position: relative;
            box-shadow: 1rem 1rem 0 rgba(43, 43, 43, 0.15);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1.5rem, 3vw, 2rem);
            margin-bottom: 2%;
            color: var(--cinnabar);
            text-align: center;
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            margin: 2% 0;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 2%;
            margin-top: 2%;
        }

        .modal-btn {
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            padding: clamp(0.5rem, 1vw, 0.8rem) clamp(1.5rem, 3vw, 2rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.2rem);
            cursor: pointer;
            box-shadow: 0.1rem 0.1rem 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .modal-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0 rgba(0, 0, 0, 0.15);
            background: var(--ink-black);
            color: #fff;
        }

        .modal-btn.primary {
            background: var(--cinnabar);
            color: #fff;
            border-color: var(--cinnabar);
        }

        .modal-btn.primary:hover {
            background: var(--ink-black);
            border-color: var(--ink-black);
        }

        /* ========== È°∂ÈÉ®ÊåâÈíÆÔºàÂºπÁ™óÂÜÖÔºâ- ‰ΩçÁΩÆ‰ºòÂåñ ========== */
        .modal-top-btn {
            position: absolute;
            top: 2%;
            background: #fff;
            border: var(--border-thin) solid var(--ink-black);
            color: var(--ink-black);
            padding: clamp(0.4rem, 1vw, 0.6rem) clamp(0.8rem, 2vw, 1.2rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.8rem, 1.5vw, 1rem);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0.1rem 0.1rem 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .modal-top-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 0.2rem 0.2rem 0 rgba(0, 0, 0, 0.15);
        }

        /* ÂïÜÂüéÊåâÈíÆÂú®Âè≥‰∏ä */
        .modal-shop-btn {
            right: 2%;
        }

        .modal-shop-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ËÉåÂåÖÊåâÈíÆÂú®Â∑¶‰∏ä */
        .modal-inventory-btn {
            left: 2%;
        }

        .modal-inventory-btn:hover {
            border-color: var(--jade);
            color: var(--jade);
        }

        /* ========== ÂïÜÂüéÂºπÁ™óÂÜÖÂÆπ ========== */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(0.5rem, 1.5vw, 0.8rem);
            margin: clamp(0.3rem, 0.8vw, 0.5rem) 0;
            border: 1px solid var(--ink-black);
            background: rgba(255, 255, 255, 0.5);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .shop-item-name {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.2rem);
        }

        .shop-item-price {
            color: var(--gold);
            font-weight: bold;
            margin: 0 clamp(0.5rem, 1vw, 1rem);
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }

        .shop-item-btn {
            padding: clamp(0.3rem, 0.8vw, 0.4rem) clamp(0.8rem, 1.5vw, 1rem);
            background: var(--jade);
            color: #fff;
            border: none;
            cursor: pointer;
            font-family: 'Ma Shan Zheng';
            /* Áªü‰∏ÄÂ≠ó‰ΩìÈ£éÊ†º */
            font-size: clamp(0.8rem, 1.5vw, 1rem);
        }

        .shop-item-btn:hover {
            background: var(--ink-black);
        }

        /* ========== ÊäïÂÖ•ËçØÊùêÂºπÁ™óÂÜÖÂÆπ - ÂìçÂ∫îÂºè‰ºòÂåñ ========== */
        .herb-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(0.5rem, 1vw, 0.8rem);
            margin: clamp(0.5rem, 1vw, 1rem) 0;
        }

        @media (min-width: 768px) {
            .herb-selector {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .herb-item {
            border: 2px solid var(--ink-black);
            padding: clamp(0.4rem, 1vw, 0.8rem);
            background: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        .herb-item-name {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.9rem, 1.8vw, 1.2rem);
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem);
        }

        .herb-item-count {
            color: var(--ink-light);
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem);
            font-size: clamp(0.7rem, 1.4vw, 0.9rem);
        }

        .herb-item-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(0.3rem, 0.8vw, 0.5rem);
        }

        .herb-item-controls button {
            width: clamp(1.5rem, 3vw, 2rem);
            height: clamp(1.5rem, 3vw, 2rem);
            border: 1px solid var(--ink-black);
            background: #fff;
            cursor: pointer;
            font-size: clamp(1rem, 2vw, 1.3rem);
        }

        .herb-item-controls button:hover {
            background: var(--paper-dark);
        }

        .herb-item-selected {
            font-weight: bold;
            font-size: clamp(1rem, 2vw, 1.3rem);
            min-width: 1.5rem;
        }

        .total-herbs {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.3rem);
            margin: clamp(0.8rem, 1.5vw, 1.2rem) 0;
            padding: clamp(0.6rem, 1.5vw, 1rem);
            background: var(--paper-dark);
            border: 2px solid var(--ink-black);
            text-align: center;
        }

        /* ========== ËÉåÂåÖÂºπÁ™óÂÜÖÂÆπ - ÂìçÂ∫îÂºè‰ºòÂåñ ========== */
        .inventory-section {
            margin-bottom: 2%;
        }

        .inventory-title {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1rem, 2vw, 1.5rem);
            color: var(--cinnabar);
            border-bottom: 2px solid var(--ink-black);
            padding-bottom: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .inventory-grid {
            display: grid;
            /* Âº∫Âà∂‰øùÊåÅ‰∏§ÂàóÂ∏ÉÂ±Ä */
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(0.3rem, 0.8vw, 1rem);
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--ink-black);
            padding: clamp(0.3rem, 0.8vw, 0.8rem);
            text-align: center;
        }

        .inventory-item-name {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            margin-bottom: 0.2rem;
        }

        .inventory-item-count {
            font-size: clamp(0.8rem, 1.6vw, 1.3rem);
            font-weight: bold;
            color: var(--jade);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(0.3rem, 0.8vw, 1rem);
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .inventory-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========== ‰∫ã‰ª∂ÂºπÁ™ó ========== */
        .event-modal {
            background: var(--paper-bg);
            border-top: clamp(0.3rem, 0.5vw, 0.5rem) solid var(--ink-black);
            border-bottom: clamp(0.3rem, 0.5vw, 0.5rem) solid var(--ink-black);
            padding: clamp(1rem, 2vw, 1.5rem);
            width: clamp(300px, 85vw, 400px);
            text-align: center;
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.5);
        }

        .event-icon {
            font-size: clamp(2rem, 4vw, 2.5rem);
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem);
        }

        .event-title {
            font-family: 'Ma Shan Zheng';
            font-size: clamp(1.3rem, 3vw, 1.8rem);
            margin-bottom: clamp(0.3rem, 0.8vw, 0.5rem);
            color: var(--cinnabar);
        }

        .event-effect {
            background: rgba(0, 0, 0, 0.05);
            padding: clamp(0.5rem, 1.5vw, 0.8rem);
            margin: clamp(0.5rem, 1vw, 1rem) 0;
            border-left: 0.2rem solid var(--ink-black);
            text-align: left;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
        }

        .event-close-btn {
            background: transparent;
            border: 2px solid var(--ink-black);
            padding: clamp(0.4rem, 1vw, 0.5rem) clamp(1rem, 2vw, 1.5rem);
            font-family: 'Ma Shan Zheng';
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            cursor: pointer;
        }

        .event-close-btn:hover {
            background: var(--ink-black);
            color: #fff;
        }
    </style>
</head>

<body>
    <!-- ÈÄÄÂá∫Á°ÆËÆ§ÂºπÁ™ó -->
    <div class="exit-overlay" id="exitOverlay" role="dialog" aria-modal="true" aria-label="Á°ÆËÆ§ÈÄÄÂá∫ÁÇº‰∏π">
        <div class="exit-dialog">
            <header>X√°c nh·∫≠n tho√°t?</header>
            <div class="body">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën tho√°t kh·ªèi (qu√° tr√¨nh) luy·ªán ƒëan kh√¥ng?</div>
            <div class="actions">
                <button id="exitCancel">H·ªßy b·ªè</button>
                <button id="exitConfirm" class="confirm">X√°c nh·∫≠n tho√°t.</button>
            </div>
        </div>
    </div>

    <!-- Toast ÈÄöÁü• -->
    <div class="toast" id="toast"></div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- ‰∫ã‰ª∂ÂºπÁ™ó -->
    <div class="modal-overlay" id="event-modal-overlay" onclick="closeEventModal()">
        <div class="event-modal" id="event-modal" onclick="event.stopPropagation()">
            <div class="event-icon" id="event-modal-icon"></div>
            <div class="event-title" id="event-modal-title"></div>
            <div class="event-description" id="event-modal-desc"></div>
            <div class="event-effect" id="event-modal-effect"></div>
            <button class="event-close-btn" onclick="closeEventModal()">ÈòÖ ÊØï</button>
        </div>
    </div>

    <!-- ÂïÜÂüéÂºπÁ™ó -->
    <div class="modal-overlay" id="shop-modal-overlay" onclick="closeShopModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">C·ª≠a h√†ng D∆∞·ª£c li·ªáu</div>
            <div style="margin-bottom: 1rem; font-size: clamp(1rem, 2vw, 1.2rem); text-align: center;">
                Ti·ªÅnÔºö<span style="color: #bfa36f;" id="money-display">5000</span>
            </div>
            <div class="modal-content" id="shop-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeShopModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- ËÉåÂåÖÂºπÁ™ó -->
    <div class="modal-overlay" id="inventory-modal-overlay" onclick="closeInventoryModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">T√∫i ƒë·ªì</div>
            <div class="modal-content" id="inventory-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeInventoryModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- ÊäïÂÖ•ËçØÊùêÂºπÁ™ó -->
    <div class="modal-overlay" id="herb-modal-overlay">
        <div class="modal" onclick="event.stopPropagation()">
            <!-- È°∂ÈÉ®ÊåâÈíÆ - ‰ΩçÁΩÆ‰ºòÂåñ -->
            <button class="modal-top-btn modal-inventory-btn" onclick="openInventoryModal()">üéí T√∫i ƒë·ªì</button>
            <button class="modal-top-btn modal-shop-btn" onclick="openShopModal()">üí∞ Th∆∞∆°ng th√†nh</button>

            <div class="modal-title">Th√™m nguy√™n li·ªáu</div>
            <div
                style="margin-bottom: 1%; color: var(--ink-light); font-size: clamp(0.9rem, 1.8vw, 1rem); text-align: center;">
                C·∫ßn b·ªè v√†o t·ª´ 6 ƒë·∫øn 10 lo·∫°i d∆∞·ª£c li·ªáu.
            </div>
            <div class="modal-content">
                <div class="herb-selector" id="herb-selector"></div>
                <div class="total-herbs">
                    ƒê√£ ch·ªçnÔºö<span id="total-selected-herbs">0</span> / 10
                    <br>Ph·∫©m ch·∫•t ban ƒë·∫ßuÔºö<span id="initial-quality-preview">0</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="startAlchemyWithHerbs()">B·∫Øt ƒë·∫ßu luy·ªán ƒëan</button>
                <button class="modal-btn" onclick="closeHerbModal()">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <!-- ÈÄÄÂá∫ÊåâÈíÆ - ÊîæÂú®game-containerÂÜÖÈÉ® -->
        <button class="exit-btn" id="btnExitAlchemy">Quay l·∫°i</button>

        <!-- È°∂ÈÉ®‰∫ã‰ª∂Ê®™ÂπÖ -->
        <div class="event-banner" id="event-banner"></div>

        <!-- Ê†∏ÂøÉÂå∫ÂüüÔºöÁ∫µÂêëËøõÂ∫¶Êù° + ‰∏πÁÇâ + ÁÅ´ÁÑ∞Êï∞ÂÄº -->
        <div class="main-stage">
            <!-- Â∑¶‰æßÔºöÂìÅË¥® -->
            <div class="vertical-gauge left">
                <div class="gauge-label">Ph·∫©m Ch·∫•t</div>
                <div class="gauge-value" id="quality-display">0</div>
                <div class="gauge-track">
                    <div class="gauge-fill fill-quality" id="quality-bar"></div>
                </div>
            </div>

            <!-- ‰∏≠Èó¥Ôºö‰∏πÁÇâ -->
            <div class="furnace-container">
                <!-- ÂºÄÂßãÁÇº‰∏πÊåâÈíÆ -->
                <button class="start-alchemy-btn" id="start-alchemy-btn" onclick="openHerbModal()">B·∫Øt ƒë·∫ßu</button>

                <!-- ÁÅ´ÁÑ∞ÂÆπÂô® -->
                <div class="furnace-fire-wrapper">
                    <div class="furnace-fire-bg" id="furnace-fire-bg"></div>
                    <div class="temp-display" id="temp-value">50</div>
                </div>
                <!-- ‰∏πÁÇâÂõæÁâá -->
                <div class="furnace-image"></div>
            </div>

            <!-- Âè≥‰æßÔºöÂÆåÊàêÂ∫¶ -->
            <div class="vertical-gauge right">
                <div class="gauge-label">Ho√†n th√†nh</div>
                <div class="gauge-value" id="completion-display">0</div>
                <div class="gauge-track">
                    <div class="gauge-fill fill-completion" id="completion-bar"></div>
                </div>
            </div>
        </div>

        <!-- Êï∞ÊçÆÊòæÁ§∫ -->
        <div class="info-display">
            <div class="info-item">
                <div class="info-label">Thao t√°c c√≤n l·∫°i</div>
                <div class="info-value" id="moves-left">15</div>
            </div>
            <div class="info-item">
                <div class="info-label">H·ªá s·ªë nhi·ªát ƒë·ªô l√≤</div>
                <div class="info-value" id="multiplier">0.8x</div>
            </div>
            <div class="info-item">
                <div class="info-label">Tr·∫°ng th√°i l√≤ ƒëan</div>
                <div class="info-value" id="status">B√¨nh th∆∞·ªùng</div>
            </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="controls" id="controls">
            <button class="control-btn" data-action="fiereFire">
                <span class="btn-title">M√£nh h·ªèa</span>
            </button>
            <button class="control-btn" data-action="gentleFire">
                <span class="btn-title">VƒÉn h·ªèa</span>
            </button>
            <button class="control-btn" data-action="addHerb">
                <span class="btn-title">Nh·∫≠p d∆∞·ª£c</span>
            </button>
            <button class="control-btn" data-action="condense">
                <span class="btn-title">Ng∆∞ng t·ª•</span>
            </button>
            <button class="control-btn" data-action="refine">
                <span class="btn-title">T√¥i luy·ªán</span>
            </button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== Êó•ÂøóÁ≥ªÁªü ==========
        function log(message) {
            console.log(`[ÁÇº‰∏πÊ®°ÊãüÂô®] ${new Date().toLocaleTimeString()} - ${message}`);
        }

        // ========== Toast ÈÄöÁü•ÂáΩÊï∞ ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ========== ‰ªéURLÂèÇÊï∞ÂàùÂßãÂåñ ==========
        const urlParams = new URLSearchParams(window.location.search);

        // Ë∞ÉËØïÔºöËæìÂá∫ÂÆåÊï¥ÁöÑURLÂèÇÊï∞
        log('========== URLÂèÇÊï∞Ë∞ÉËØï ==========');
        log(`ÂÆåÊï¥URL: ${window.location.href}`);
        log(`URLÂèÇÊï∞Â≠óÁ¨¶‰∏≤: ${window.location.search}`);

        // ÈÄê‰∏™ËæìÂá∫ÂèÇÊï∞
        for (const [key, value] of urlParams.entries()) {
            log(`ÂèÇÊï∞ ${key} = ${value}`);
        }

        // ========== ËßíËâ≤Â±ûÊÄß ==========
        let playerStats = {
            rootBone: parseInt(urlParams.get('rootBone')) || 0,      // Ê†πÈ™®
            comprehension: parseInt(urlParams.get('comprehension')) || 0, // ÊÇüÊÄß
            nature: parseInt(urlParams.get('nature')) || 0,        // ÂøÉÊÄß
            charm: parseInt(urlParams.get('charm')) || 0          // È≠ÖÂäõ
        };

        log(`Ëß£ÊûêÂêéÁöÑËßíËâ≤Â±ûÊÄß: ${JSON.stringify(playerStats)}`);

        let money = parseInt(urlParams.get('money')) || 5000;
        log(`Ëß£ÊûêÂêéÁöÑÈáëÈí±: ${money} (ÂéüÂßãÂÄº: ${urlParams.get('money')})`);

        let herbs = {
            danshen: parseInt(urlParams.get('danshen')) || 0,   // ‰∏πÂèÇ
            danggui: parseInt(urlParams.get('danggui')) || 0,   // ÂΩìÂΩí
            moyao: parseInt(urlParams.get('moyao')) || 0,     // Ê≤°ËçØ
            chenxiang: parseInt(urlParams.get('chenxiang')) || 0  // Ê≤âÈ¶ô
        };

        log(`Ëß£ÊûêÂêéÁöÑËçØÊùê: ${JSON.stringify(herbs)}`);

        let pills = {
            daliwan: parseInt(urlParams.get('daliwan')) || 0,      // Â§ßÂäõ‰∏∏
            jingutie: parseInt(urlParams.get('jingutie')) || 0,     // Á≠ãÈ™®Ë¥¥
            jinchuangyao: parseInt(urlParams.get('jinchuangyao')) || 0, // ÈáëÁñÆËçØ
            piliwan: parseInt(urlParams.get('piliwan')) || 0       // ÈúπÈõ≥‰∏∏
        };

        log(`Ëß£ÊûêÂêéÁöÑ‰∏πËçØ: ${JSON.stringify(pills)}`);
        log('========== ÂàùÂßãÂåñÂÆåÊàê ==========');

        const herbNames = {
            danshen: 'ƒêan s√¢m',
            danggui: 'ƒê∆∞∆°ng quy',
            moyao: 'M·ªôt d∆∞·ª£c',
            chenxiang: 'Tr·∫ßm h∆∞∆°ng'
        };

        const pillNames = {
            daliwan: 'ƒê·∫°i l·ª±c ho√†n',
            jingutie: 'Cao d√°n g√¢n c·ªët',
            jinchuangyao: 'Kim sang d∆∞·ª£c',
            piliwan: 'Ph√≠ch l·ªãch ho√†n'
        };

        const statNames = {
            rootBone: 'CƒÉn c·ªët',
            comprehension: 'Ng·ªô t√≠nh',
            nature: 'T√¢m T√≠nh',
            charm: 'M·ªã L·ª±c'
        };

        // ËçØÊùê‰∏éÂ±ûÊÄßÁöÑÂØπÂ∫îÂÖ≥Á≥ª
        const herbToStat = {
            danshen: 'rootBone',      // ‰∏πÂèÇ ‚Üí Ê†πÈ™®
            danggui: 'comprehension', // ÂΩìÂΩí ‚Üí ÊÇüÊÄß
            moyao: 'nature',          // Ê≤°ËçØ ‚Üí ÂøÉÊÄß
            chenxiang: 'charm'        // Ê≤âÈ¶ô ‚Üí È≠ÖÂäõ
        };

        let selectedHerbs = {
            danshen: 0,
            danggui: 0,
            moyao: 0,
            chenxiang: 0
        };

        // ËÆ∞ÂΩïÁÇº‰∏πÊó∂ÊäïÂÖ•ÁöÑËçØÊùêÔºàÁî®‰∫éËÆ°ÁÆóÂ±ûÊÄßÔºâ
        let herbsUsedForAlchemy = {};

        let gameState = {
            temperature: 50, quality: 0, completion: 0, movesLeft: 15,
            gameOver: false, turnCount: 0, lastEventWasNegative: false,
            alchemyStarted: false
        };

        const actions = {
            fiereFire: { name: 'M√£nh H·ªèa', desc: 'TƒÉng nhi·ªát ƒë·ªô l·ªõn', effects: { temperature: [25, 35], quality: [-5, -2], completion: [0, 0] } },
            gentleFire: { name: 'VƒÉn H·ªèa', desc: 'Vi ch·ªânh c√¢n b·∫±ng', effects: { temperature: [5, 10], quality: [3, 6], completion: [4, 8] } },
            addHerb: { name: 'Th√™m D∆∞·ª£c', desc: 'TƒÉng ti·∫øn ƒë·ªô', effects: { temperature: [-15, -5], quality: [2, 4], completion: [8, 15] } },
            condense: { name: 'Ng∆∞ng T·ª•', desc: 'Gi·∫£m nhi·ªát ng∆∞ng ƒëan', effects: { temperature: [-30, -20], quality: [8, 12], completion: [0, 2] } },
            refine: { name: 'T√¥i Luy·ªán', desc: 'Tinh l·ªçc t·∫°p ch·∫•t', effects: { temperature: [5, 10], quality: [5, 8], completion: [-10, -5] } }
        };

        let activeEvents = [];
        const eventLibrary = [
            { id: 'cold_snap', name: 'H√†n Tri·ªÅu', type: 'negative', icon: '‚ùÑÔ∏è', desc: 'H√†n kh√≠ x√¢m nh·∫≠p, nhi·ªát ƒë·ªô l√≤ gi·∫£m m·∫°nh', effectDesc: 'Nhi·ªát ƒë·ªô l√≤ -15, l·∫ßn M√£nh H·ªèa t·ªõi gi·∫£m m·ªôt n·ª≠a hi·ªáu qu·∫£', activeEffect: 'M√£nh H·ªèa sau gi·∫£m 50%', duration: 0, probability: 0.15, onTrigger: (s) => { s.temperature = Math.max(0, s.temperature - 15); return { nextFireHalved: true, duration: 1 }; } },
            { id: 'clog', name: 'T·∫Øc Ngh·∫Ωn', type: 'negative', icon: 'üö´', desc: 'C·∫∑n d∆∞·ª£c l√†m t·∫Øc l·ªó kh√≠', effectDesc: 'L·∫ßn Ng∆∞ng T·ª• ti·∫øp theo v√¥ hi·ªáu', activeEffect: 'Ng∆∞ng T·ª• sau v√¥ hi·ªáu', duration: 1, probability: 0.12, onTrigger: () => ({ coolDisabled: true }) },
            { id: 'backlash', name: 'Ph·∫£n Ph·ªá', type: 'negative', icon: 'üî•', desc: 'H·ªèa kh√≠ b·∫°o lo·∫°n x√¢m th·ª±c d∆∞·ª£c t√≠nh', effectDesc: 'M·ªói l∆∞·ª£t Ph·∫©m Ch·∫•t -5', activeEffect: 'M·ªói l∆∞·ª£t Ph·∫©m Ch·∫•t -5', duration: 3, probability: 0.1, onTick: (s) => { s.quality = Math.max(0, s.quality - 5); } },
            { id: 'distraction', name: 'T√¢m Ma', type: 'negative', icon: 'üòµ', desc: 'T√¢m th·∫ßn b·∫•t ƒë·ªãnh', effectDesc: 'Bi·∫øn ƒë·ªông l·∫ßn t·ªõi g·∫•p ƒë√¥i', activeEffect: 'Bi·∫øn ƒë·ªông sau x2', duration: 1, probability: 0.13, onTrigger: () => ({ varianceDoubled: true }) },
            { id: 'blessing', name: 'T∆∞·ªùng Th·ª•y', type: 'positive', icon: '‚ú®', desc: 'T·ª≠ kh√≠ ƒë√¥ng lai', effectDesc: 'Ph·∫©m Ch·∫•t +15', activeEffect: 'Ph·∫©m Ch·∫•t +15', duration: 0, probability: 0.12, onTrigger: (s) => { s.quality = Math.min(100, s.quality + 15); } },
            { id: 'epiphany', name: 'ƒê·ªën Ng·ªô', type: 'positive', icon: 'üí°', desc: 'Lƒ©nh ng·ªô tinh t√∫y kh·ªëng h·ªèa', effectDesc: 'L·∫ßn t·ªõi kh√¥ng t·ªën l∆∞·ª£t', activeEffect: 'L·∫ßn t·ªõi kh√¥ng t·ªën l∆∞·ª£t', duration: 1, probability: 0.1, onTrigger: () => ({ freeTurn: true }) },
            { id: 'wind_aid', name: 'Phong Tr·ª£', type: 'positive', icon: 'üå™Ô∏è', desc: 'Gi√≥ tr·ª£ th·∫ø l·ª≠a', effectDesc: 'L·∫ßn M√£nh H·ªèa t·ªõi x2.5', activeEffect: 'M√£nh H·ªèa sau x2.5', duration: 1, probability: 0.08, onTrigger: () => ({ fireBoost: 2.5 }) },
            { id: 'shield', name: 'H·ªô Ch·ªß', type: 'positive', icon: 'üõ°Ô∏è', desc: 'Kh√≠ Linh h·ªô th·ªÉ', effectDesc: 'Ch·∫∑n m·ªôt l·∫ßn n·ªï l√≤', activeEffect: 'Ch·∫∑n n·ªï l√≤', duration: 1, probability: 0.08, onTrigger: () => ({ explosionShield: true }) },
            { id: 'boiling', name: 'S√¥i Tr√†o', type: 'neutral', icon: '‚ô®Ô∏è', desc: 'Linh kh√≠ ho·∫°t b√°t', effectDesc: 'T·∫•t c·∫£ hi·ªáu qu·∫£ g·∫•p ƒë√¥i', activeEffect: 'Hi·ªáu qu·∫£ x2', duration: 2, probability: 0.08, onTrigger: () => ({ allDoubled: true }) },
            { id: 'reverse', name: '√Çm H·ªèa', type: 'neutral', icon: 'üîÑ', desc: '√Çm d∆∞∆°ng ƒëi√™n ƒë·∫£o h√†n th·ª≠ ngh·ªãch chuy·ªÉn', effectDesc: 'Thao t√°c t·ªõi bi·∫øn ƒë·ªïi nhi·ªát ƒë·ªô ƒë·∫£o ng∆∞·ª£c (tƒÉng th√†nh gi·∫£m, gi·∫£m th√†nh tƒÉng)', activeEffect: 'Nhi·ªát ƒë·ªô l·∫ßn t·ªõi ƒë·∫£o ng∆∞·ª£c', duration: 1, probability: 0.06, onTrigger: () => ({ temperatureReversed: true }) },
            { id: 'lock_multiplier', name: 'Ng∆∞ng ƒêan', type: 'neutral', icon: 'üíé', desc: 'Kho·∫£nh kh·∫Øc d·ªãch thu·ªëc ƒë√¥ng l·∫°i, th·ªùi gian nh∆∞ng ƒë·ªçng', effectDesc: 'Duy tr√¨ 2 l∆∞·ª£t, b·ªôi s·ªë nhi·ªát ƒë·ªô l√≤ kh√≥a ·ªü m·ª©c 1.5x', activeEffect: 'Kh√≥a b·ªôi s·ªë 1.5x', duration: 2, probability: 0.08, onTrigger: () => ({ multiplierLocked: 1.5 }) }
        ];

        // ========== Ch·ª©c nƒÉng C·ª≠a H√†ng ==========
        function openShopModal() {
            document.getElementById('money-display').textContent = money;
            const shopContent = document.getElementById('shop-content');
            shopContent.innerHTML = '';

            Object.keys(herbs).forEach(herbKey => {
                const herbName = herbNames[herbKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <span class="shop-item-name">${herbName}</span>
                    <span style="color: var(--ink-light); font-size: clamp(0.8rem, 1.5vw, 0.9rem);">ƒêang c√≥: ${herbs[herbKey]}</span>
                    <span class="shop-item-price">500 V√†ng</span>
                    <button class="shop-item-btn" onclick="buyHerb('${herbKey}')">Mua</button>
                `;
                shopContent.appendChild(itemDiv);
            });

            document.getElementById('shop-modal-overlay').classList.add('active');
        }

        function closeShopModal() {
            document.getElementById('shop-modal-overlay').classList.remove('active');
        }

        function buyHerb(herbKey) {
            if (money >= 500) {
                money -= 500;
                herbs[herbKey]++;
                log(`Mua ${herbNames[herbKey]}, ti√™u 500 v√†ng, v√†ng hi·ªán t·∫°i: ${money}, kho ${herbNames[herbKey]}: ${herbs[herbKey]}`);
                openShopModal(); // L√†m m·ªõi hi·ªÉn th·ªã c·ª≠a h√†ng
                updateHerbDisplay(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã giao di·ªán th√™m d∆∞·ª£c li·ªáu
                showToast(`Mua h√†ng th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${herbNames[herbKey]} x1`, 'success');
            } else {
                showToast('Kh√¥ng ƒë·ªß ti·ªÅn!', 'error');
            }
        }

        // ========== ËÉåÂåÖÂäüËÉΩ ==========
        function openInventoryModal() {
            const inventoryContent = document.getElementById('inventory-content');
            inventoryContent.innerHTML = '';

            // ÊòæÁ§∫Â±ûÊÄß
            let statsHtml = '<div class="inventory-section"><div class="inventory-title">Thu·ªôc t√≠nh nh√¢n v·∫≠t</div><div class="stats-grid">';
            Object.keys(playerStats).forEach(stat => {
                statsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${statNames[stat]}</div>
                    <div class="inventory-item-count">${playerStats[stat]}</div>
                </div>`;
            });
            statsHtml += '</div></div>';

            // ÊòæÁ§∫ËçØÊùê
            let herbsHtml = '<div class="inventory-section"><div class="inventory-title">D∆∞·ª£c li·ªáu</div><div class="inventory-grid">';
            Object.keys(herbs).forEach(herbKey => {
                herbsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${herbNames[herbKey]}</div>
                    <div class="inventory-item-count">${herbs[herbKey]}</div>
                </div>`;
            });
            herbsHtml += '</div></div>';

            // ÊòæÁ§∫‰∏πËçØ
            let pillsHtml = '<div class="inventory-section"><div class="inventory-title">ƒêan d∆∞·ª£c</div><div class="inventory-grid">';
            Object.keys(pills).forEach(pillKey => {
                pillsHtml += `<div class="inventory-item">
                    <div class="inventory-item-name">${pillNames[pillKey]}</div>
                    <div class="inventory-item-count">${pills[pillKey]}</div>
                </div>`;
            });
            pillsHtml += '</div></div>';

            inventoryContent.innerHTML = statsHtml + herbsHtml + pillsHtml;
            document.getElementById('inventory-modal-overlay').classList.add('active');
        }

        function closeInventoryModal() {
            document.getElementById('inventory-modal-overlay').classList.remove('active');
        }

        // ========== ÊäïÂÖ•ËçØÊùêÂäüËÉΩ ==========
        function openHerbModal() {
            Object.keys(selectedHerbs).forEach(key => selectedHerbs[key] = 0);
            renderHerbSelector();
            updateHerbTotal();
            document.getElementById('herb-modal-overlay').classList.add('active');
        }

        function renderHerbSelector() {
            const herbSelector = document.getElementById('herb-selector');
            herbSelector.innerHTML = '';

            Object.keys(herbs).forEach(herbKey => {
                const herbName = herbNames[herbKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'herb-item';
                itemDiv.innerHTML = `
                    <div class="herb-item-name">${herbName}</div>
                    <div class="herb-item-count" id="herb-count-${herbKey}">ƒêang c√≥: ${herbs[herbKey]}</div>
                    <div class="herb-item-controls">
                        <button onclick="changeHerbCount('${herbKey}', -1)">-</button>
                        <span class="herb-item-selected" id="selected-${herbKey}">${selectedHerbs[herbKey] || 0}</span>
                        <button onclick="changeHerbCount('${herbKey}', 1)">+</button>
                    </div>
                `;
                herbSelector.appendChild(itemDiv);
            });
        }

        function updateHerbDisplay() {
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªìn kho trong giao di·ªán th√™m d∆∞·ª£c li·ªáu
            if (document.getElementById('herb-modal-overlay').classList.contains('active')) {
                Object.keys(herbs).forEach(herbKey => {
                    const countElement = document.getElementById(`herb-count-${herbKey}`);
                    if (countElement) {
                        countElement.textContent = `ƒêang c√≥: ${herbs[herbKey]}`;
                    }
                });
            }
        }

        function closeHerbModal() {
            document.getElementById('herb-modal-overlay').classList.remove('active');
        }

        function changeHerbCount(herbKey, delta) {
            const newValue = selectedHerbs[herbKey] + delta;
            const totalSelected = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);

            if (newValue < 0) return;
            if (newValue > herbs[herbKey]) {
                showToast(`Kho ${herbNames[herbKey]} kh√¥ng ƒë·ªß!`, 'error');
                return;
            }
            if (delta > 0 && totalSelected >= 10) {
                showToast('T·ªëi ƒëa ch·ªâ ƒë∆∞·ª£c ch·ªçn 10 d∆∞·ª£c li·ªáu!', 'error');
                return;
            }

            selectedHerbs[herbKey] = newValue;
            document.getElementById(`selected-${herbKey}`).textContent = newValue;
            updateHerbTotal();
        }

        function updateHerbTotal() {
            const total = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);
            document.getElementById('total-selected-herbs').textContent = total;

            const initialQuality = Math.max(0, (total - 6) * 5);
            document.getElementById('initial-quality-preview').textContent = initialQuality;
        }

        function startAlchemyWithHerbs() {
            const total = Object.values(selectedHerbs).reduce((a, b) => a + b, 0);

            if (total < 6) {
                showToast('C·∫ßn √≠t nh·∫•t 6 d∆∞·ª£c li·ªáu!', 'error');
                return;
            }

            // Ghi l·∫°i d∆∞·ª£c li·ªáu ƒë√£ d√πng (ƒë·ªÉ t√≠nh thu·ªôc t√≠nh)
            herbsUsedForAlchemy = { ...selectedHerbs };
            log(`B·∫Øt ƒë·∫ßu luy·ªán ƒëan, d∆∞·ª£c li·ªáu: ${JSON.stringify(herbsUsedForAlchemy)}`);

            // Tr·ª´ d∆∞·ª£c li·ªáu
            Object.keys(selectedHerbs).forEach(herbKey => {
                herbs[herbKey] -= selectedHerbs[herbKey];
                if (selectedHerbs[herbKey] > 0) {
                    log(`Ti√™u th·ª• ${herbNames[herbKey]} x${selectedHerbs[herbKey]}, c√≤n l·∫°i: ${herbs[herbKey]}`);
                }
            });

            const initialQuality = Math.max(0, (total - 6) * 5);
            gameState.quality = initialQuality;
            gameState.alchemyStarted = true;

            closeHerbModal();
            document.getElementById('start-alchemy-btn').classList.add('hidden');
            updateDisplay();
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
        }

        // ========== TƒÉng thu·ªôc t√≠nh ==========
        function addRandomAttribute(points) {
            // T√≠nh t·ªïng d∆∞·ª£c li·ªáu
            const totalHerbs = Object.values(herbsUsedForAlchemy).reduce((a, b) => a + b, 0);
            if (totalHerbs === 0) return;

            // T√≠nh tr·ªçng s·ªë x√°c su·∫•t
            const weights = [];
            const stats = [];

            Object.keys(herbsUsedForAlchemy).forEach(herbKey => {
                if (herbsUsedForAlchemy[herbKey] > 0) {
                    weights.push(herbsUsedForAlchemy[herbKey]);
                    stats.push(herbToStat[herbKey]);
                }
            });

            // Ch·ªçn ng·∫´u nhi√™n thu·ªôc t√≠nh
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            let selectedStat = null;

            for (let i = 0; i < weights.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    selectedStat = stats[i];
                    break;
                }
            }

            if (selectedStat) {
                playerStats[selectedStat] += points;
                log(`Thu·ªôc t√≠nh tƒÉng: ${statNames[selectedStat]} +${points}, hi·ªán t·∫°i: ${playerStats[selectedStat]}`);
                showToast(`${statNames[selectedStat]} +${points}!`, 'success');
            }
        }

        // Tooltip
        let tooltipTimeout, longPressTimer;
        function showTooltip(element, content, x, y) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = content; tooltip.classList.add('show');
            const rect = element.getBoundingClientRect();
            const tRect = tooltip.getBoundingClientRect();
            let left = x || rect.left + rect.width / 2 - tRect.width / 2;
            let top = y || rect.top - tRect.height - 10;
            if (left < 10) left = 10; if (left + tRect.width > window.innerWidth) left = window.innerWidth - tRect.width - 10;
            if (top < 10) top = rect.bottom + 10;
            tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
        }
        function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }
        function formatRange(min, max) { return (min === max) ? String(min) : `${min > 0 ? '+' : ''}${min}~${min > 0 ? '+' : ''}${max}`; }
        function getValueClass(v) { return v > 0 ? 'positive' : (v < 0 ? 'negative' : 'neutral'); }

        function generateActionTooltip(actionType) {
            const action = actions[actionType];
            const m = calculateMultiplier();
            const e = action.effects;
            const qMin = Math.round(e.quality[0] * m), qMax = Math.round(e.quality[1] * m);
            const cMin = Math.round(e.completion[0] * m), cMax = Math.round(e.completion[1] * m);
            let html = `<div class="tooltip-title">${action.name}</div><div style="margin-bottom:5px;opacity:0.8">${action.desc}</div>`;
            html += `<div class="tooltip-range"><span>Nhi·ªát ƒë·ªô</span><span class="${getValueClass(e.temperature[0])}">${formatRange(e.temperature[0], e.temperature[1])}</span></div>`;
            html += `<div class="tooltip-range"><span>Ph·∫©m ch·∫•t</span><span class="${getValueClass(qMin)}">${formatRange(qMin, qMax)}</span></div>`;
            html += `<div class="tooltip-range"><span>Ti·∫øn ƒë·ªô</span><span class="${getValueClass(cMin)}">${formatRange(cMin, cMax)}</span></div>`;
            return html;
        }

        function initializeControls() {
            document.querySelectorAll('.control-btn').forEach(btn => {
                const action = btn.getAttribute('data-action');
                btn.addEventListener('mouseenter', function () { if (!btn.disabled) tooltipTimeout = setTimeout(() => showTooltip(this, generateActionTooltip(action)), 300); });
                btn.addEventListener('mouseleave', () => { clearTimeout(tooltipTimeout); hideTooltip(); });
                btn.addEventListener('touchstart', function (e) { if (!btn.disabled) longPressTimer = setTimeout(() => showTooltip(this, generateActionTooltip(action), e.touches[0].clientX, e.touches[0].clientY - 80), 500); });
                btn.addEventListener('touchend', () => clearTimeout(longPressTimer));
                btn.addEventListener('click', () => { hideTooltip(); performAction(action); });
            });
        }

        function showEventModal(e) {
            document.getElementById('event-modal-icon').textContent = e.icon;
            document.getElementById('event-modal-title').textContent = e.name;
            document.getElementById('event-modal-desc').textContent = e.desc;
            document.getElementById('event-modal-effect').textContent = e.effectDesc;
            document.getElementById('event-modal-overlay').classList.add('active');
        }
        function closeEventModal() { document.getElementById('event-modal-overlay').classList.remove('active'); }

        function getRandom(min, max) { return Math.random() * (max - min) + min; }
        function calculateMultiplier() {
            const lock = activeEvents.find(e => e.multiplierLocked); if (lock) return lock.multiplierLocked;
            if (gameState.temperature <= 30) return 0.3 + (gameState.temperature / 30) * 0.2;
            if (gameState.temperature <= 70) return 0.5 + ((gameState.temperature - 30) / 40) * 0.5;
            return 1.0 + ((gameState.temperature - 70) / 30) * 0.8;
        }

        function triggerRandomEvent() {
            if (gameState.turnCount <= 2 || gameState.movesLeft <= 1 || Math.random() > 0.35) return;
            let pool = eventLibrary.filter(e => !(e.type === 'negative' && gameState.lastEventWasNegative) && Math.random() < (e.probability / 0.35));
            if (!pool.length) return;
            const evt = pool[Math.floor(Math.random() * pool.length)];
            gameState.lastEventWasNegative = (evt.type === 'negative');
            const res = evt.onTrigger ? evt.onTrigger(gameState) : {};
            const active = { ...evt, ...res, remainingDuration: evt.duration };
            activeEvents.push(active);
            showEventModal(evt); displayEventCard(active);
        }

        function displayEventCard(e) {
            const div = document.createElement('div');
            div.className = `event-card ${e.type}`; div.setAttribute('data-id', e.id);
            div.innerHTML = `<span>${e.name}</span><span style="opacity:0.7;font-size:0.7em">${e.activeEffect}</span>`;
            document.getElementById('event-banner').appendChild(div);
            div.addEventListener('click', () => showEventModal(e));
            if (e.duration === 0) setTimeout(() => div.remove(), 3000);
        }

        function updateEventDuration() {
            activeEvents = activeEvents.filter(e => {
                if (e.onTick) e.onTick(gameState);
                e.remainingDuration--;
                const card = document.querySelector(`.event-card[data-id="${e.id}"]`);
                if (e.remainingDuration < 0) { if (card) card.remove(); return false; }
                return true;
            });
        }

        function updateDisplay() {
            const m = calculateMultiplier();
            document.getElementById('temp-value').textContent = Math.round(gameState.temperature);
            document.getElementById('moves-left').textContent = gameState.movesLeft;
            document.getElementById('quality-display').textContent = Math.round(gameState.quality);
            document.getElementById('completion-display').textContent = Math.round(gameState.completion);

            const mulEl = document.getElementById('multiplier');
            mulEl.textContent = m.toFixed(1) + 'x';
            mulEl.className = 'info-value ' + (gameState.temperature > 85 ? 'danger-text' : '');

            document.getElementById('quality-bar').style.height = gameState.quality + '%';
            document.getElementById('completion-bar').style.height = gameState.completion + '%';

            const bg = document.getElementById('furnace-fire-bg');
            const status = document.getElementById('status');
            bg.className = 'furnace-fire-bg'; status.className = 'info-value';
            if (gameState.temperature > 90) { bg.classList.add('danger'); status.textContent = 'Nguy Hi·ªÉm'; status.classList.add('danger-text'); }
            else if (gameState.temperature > 70) { bg.classList.add('hot'); status.textContent = 'N√≥ng'; status.classList.add('danger-text'); }
            else if (gameState.temperature < 30) { bg.classList.add('cold'); status.textContent = 'Ngu·ªôi'; }
            else { bg.classList.add('normal'); status.textContent = 'B√¨nh Th∆∞·ªùng'; }
        }

        function performAction(type) {
            if (!gameState.alchemyStarted) {
                showToast('Vui l√≤ng nh·∫•n n√∫t "B·∫Øt ƒë·∫ßu" tr∆∞·ªõc!', 'error');
                return;
            }
            if (gameState.gameOver || gameState.movesLeft <= 0) return;
            gameState.turnCount++;
            const action = actions[type];
            const e = action.effects;
            const m = calculateMultiplier();

            let mod = { t: 1, q: 1, c: 1, v: 1, free: false };
            activeEvents.forEach(evt => {
                if (evt.allDoubled) { mod.t *= 2; mod.q *= 2; mod.c *= 2; }
                if (evt.fireBoost && type === 'fiereFire') mod.t *= evt.fireBoost;
                if (evt.nextFireHalved && type === 'fiereFire') { mod.t *= 0.5; evt.remainingDuration = -1; }
                if (evt.coolDisabled && type === 'condense') { mod.t = 0; evt.remainingDuration = -1; }
                if (evt.varianceDoubled) mod.v = 2;
                if (evt.freeTurn) { mod.free = true; evt.remainingDuration = -1; }
                if (evt.temperatureReversed) { mod.t *= -1; evt.remainingDuration = -1; }
            });

            let dt = getRandom(e.temperature[0], e.temperature[1]);
            let dq = getRandom(e.quality[0], e.quality[1]);
            let dc = getRandom(e.completion[0], e.completion[1]);

            if (mod.v > 1) { const center = (e.temperature[0] + e.temperature[1]) / 2; dt = center + (dt - center) * mod.v; }

            dt *= mod.t;
            dq = dq * m * mod.q;
            dc = dc * m * mod.c;

            if (gameState.temperature > 80) dq -= (gameState.temperature - 80) * 0.2;

            gameState.temperature = Math.max(0, gameState.temperature + dt);
            gameState.quality = Math.max(0, Math.min(100, gameState.quality + dq));
            gameState.completion = Math.max(0, Math.min(100, gameState.completion + dc));

            if (!mod.free) gameState.movesLeft--;
            updateEventDuration();

            const hasShield = activeEvents.some(e => e.explosionShield);
            if (gameState.temperature > 100) {
                if (hasShield) {
                    gameState.temperature = 99; activeEvents = activeEvents.filter(e => !e.explosionShield);
                    showToast('Kh√≠ Linh H·ªô Ch·ªß k√≠ch ho·∫°t!', 'success');
                } else { gameOver(false, 'Nhi·ªát ƒë·ªô qu√° cao, l√≤ luy·ªán ƒëan ph√°t n·ªï!'); return; }
            }

            updateDisplay();
            triggerRandomEvent();

            if (gameState.completion >= 100) {
                gameState.completion = 100; updateDisplay();
                const product = getProduct(gameState.quality);
                gameOver(true, `Luy·ªán ƒëan th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c: ${product}`);
                return;
            }
            if (gameState.movesLeft === 0) gameOver(false, `H·∫øt l∆∞·ª£t thao t√°c, luy·ªán ƒëan th·∫•t b·∫°i!`);
        }

        function getProduct(q) {
            let productName = '';
            let points = 0;

            if (q >= 100) {
                productName = '„ÄêC·ª≠u Chuy·ªÉn Kim ƒêan„Äë(Truy·ªÅn Thuy·∫øt)';
                points = 3;
            } else if (q >= 90) {
                productName = '„ÄêD·ªãch C√¢n ƒêan„Äë(S·ª≠ Thi)';
                points = 2;
            } else if (q >= 75) {
                productName = '„ÄêB·ªìi Nguy√™n ƒêan„Äë(Hi·∫øm)';
                points = 1;
            } else if (q >= 50) {
                const commonPills = ['daliwan', 'jingutie', 'jinchuangyao', 'piliwan'];
                const pillNames = {
                    daliwan: '„Äêƒê·∫°i L·ª±c Ho√†n„Äë(Th∆∞·ªùng)',
                    jingutie: '„ÄêCao D√°n G√¢n C·ªët„Äë(Th∆∞·ªùng)',
                    jinchuangyao: '„ÄêKim Sang D∆∞·ª£c„Äë(Th∆∞·ªùng)',
                    piliwan: '„ÄêPh√≠ch L·ªãch Ho√†n„Äë(Th∆∞·ªùng)'
                };
                const randomPill = commonPills[Math.floor(Math.random() * commonPills.length)];
                pills[randomPill]++;
                productName = pillNames[randomPill];
                log(`Nh·∫≠n ƒë∆∞·ª£c ƒëan d∆∞·ª£c: ${productName.replace(/„Äê|„Äë|\(.*\)/g, '')}, kho hi·ªán t·∫°i: ${pills[randomPill]}`);
            } else {
                productName = 'Kh√¥ng c√≥ th√†nh ph·∫©m';
            }

            // Th√™m thu·ªôc t√≠nh d·ª±a tr√™n ph·∫©m ch·∫•t
            if (points > 0) {
                addRandomAttribute(points);
            }

            log(`K·∫øt qu·∫£ luy·ªán ƒëan: Ph·∫©m ch·∫•t ${q}, ${productName}`);
            return productName;
        }

        function gameOver(success, msg) {
            gameState.gameOver = true;
            const el = document.getElementById('message');
            el.innerHTML = `<div>${msg}</div><div style="font-size:0.8em;margin-top:0.3em;opacity:0.8">ÂìÅË¥®:${Math.round(gameState.quality)}</div><div style="font-size:0.7em;margin-top:0.5em;opacity:0.6">3ÁßíÂêéËá™Âä®ÈÄÄÂá∫...</div>`;
            el.className = 'message ' + (success ? 'success' : 'failure');
            el.style.display = 'block';
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);

            // 3ÁßíÂêéËá™Âä®ÈÄÄÂá∫ÁÇº‰∏πÁïåÈù¢
            setTimeout(() => {
                // ÊûÑÂª∫ËøîÂõûÊï∞ÊçÆ
                const returnData = {
                    type: 'alchemy-exit',
                    money: money,
                    herbs: {
                        danshen: herbs.danshen,
                        danggui: herbs.danggui,
                        moyao: herbs.moyao,
                        chenxiang: herbs.chenxiang
                    },
                    pills: {
                        daliwan: pills.daliwan,
                        jingutie: pills.jingutie,
                        jinchuangyao: pills.jinchuangyao,
                        piliwan: pills.piliwan
                    },
                    playerStats: {
                        rootBone: playerStats.rootBone,
                        comprehension: playerStats.comprehension,
                        nature: playerStats.nature,
                        charm: playerStats.charm
                    }
                };

                log(`ÁÇº‰∏πÁªìÊùüÔºåËá™Âä®ÈÄÄÂá∫ÔºåËøîÂõûÊï∞ÊçÆ: ${JSON.stringify(returnData)}`);

                // ÂèëÈÄÅÊ∂àÊÅØÁªôÁà∂Á™óÂè£
                window.parent.postMessage(returnData, '*');
            }, 3000);
        }

        function resetGame() {
            gameState = {
                temperature: 50, quality: 0, completion: 0, movesLeft: 15,
                gameOver: false, turnCount: 0, lastEventWasNegative: false,
                alchemyStarted: false
            };
            activeEvents = [];
            document.getElementById('event-banner').innerHTML = '';
            document.getElementById('message').style.display = 'none';
            closeEventModal(); hideTooltip();
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
            document.getElementById('start-alchemy-btn').classList.remove('hidden');
            updateDisplay();
        }

        initializeControls();
        updateDisplay();
        document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
        document.addEventListener('click', (e) => { if (!e.target.closest('.control-btn') && !e.target.closest('.event-card')) hideTooltip(); });

        // ========== ÈÄÄÂá∫ÁÇº‰∏πÂäüËÉΩ ==========
        const exitOverlay = document.getElementById('exitOverlay');

        document.getElementById('btnExitAlchemy').addEventListener('click', function () {
            exitOverlay.style.display = 'flex';
        });

        document.getElementById('exitCancel').addEventListener('click', function () {
            exitOverlay.style.display = 'none';
        });

        document.getElementById('exitConfirm').addEventListener('click', function () {
            // ÊûÑÂª∫ËøîÂõûÊï∞ÊçÆ
            const returnData = {
                type: 'alchemy-exit',
                money: money,
                herbs: {
                    danshen: herbs.danshen,
                    danggui: herbs.danggui,
                    moyao: herbs.moyao,
                    chenxiang: herbs.chenxiang
                },
                pills: {
                    daliwan: pills.daliwan,
                    jingutie: pills.jingutie,
                    jinchuangyao: pills.jinchuangyao,
                    piliwan: pills.piliwan
                },
                playerStats: {
                    rootBone: playerStats.rootBone,
                    comprehension: playerStats.comprehension,
                    nature: playerStats.nature,
                    charm: playerStats.charm
                }
            };

            log(`ÈÄÄÂá∫ÁÇº‰∏πÔºåËøîÂõûÊï∞ÊçÆ: ${JSON.stringify(returnData)}`);

            try {
                exitOverlay.style.display = 'none';
            } catch (_) { }

            // ÂèëÈÄÅÊ∂àÊÅØÁªôÁà∂Á™óÂè£
            window.parent.postMessage(returnData, '*');
        });
    </script>
</body>

</html>